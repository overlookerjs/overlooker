(function(){var d=d||{};d.scope={};d.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};d.global=d.getGlobal(this);d.ASSUME_ES5=!1;d.ASSUME_NO_NATIVE_MAP=!1;d.ASSUME_NO_NATIVE_SET=!1;d.defineProperty=d.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};d.SYMBOL_PREFIX="jscomp_symbol_";
d.initSymbol=function(){d.initSymbol=function(){};d.global.Symbol||(d.global.Symbol=d.Symbol)};d.symbolCounter_=0;d.Symbol=function(a){return d.SYMBOL_PREFIX+(a||"")+d.symbolCounter_++};d.initSymbolIterator=function(){d.initSymbol();var a=d.global.Symbol.iterator;a||(a=d.global.Symbol.iterator=d.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&d.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return d.arrayIterator(this)}});d.initSymbolIterator=function(){}};
d.arrayIterator=function(a){var b=0;return d.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};d.iteratorPrototype=function(a){d.initSymbolIterator();a={next:a};a[d.global.Symbol.iterator]=function(){return this};return a};d.makeIterator=function(a){d.initSymbolIterator();var b=a[Symbol.iterator];return b?b.call(a):d.arrayIterator(a)};d.arrayFromIterator=function(a){for(var b,c=[];!(b=a.next()).done;)c.push(b.value);return c};
d.arrayFromIterable=function(a){return a instanceof Array?a:d.arrayFromIterator(d.makeIterator(a))};var e=0;function g(a,b){var c=XMLHttpRequest.prototype.send,f=e++;XMLHttpRequest.prototype.send=function(k){for(var h=[],l=0;l<arguments.length;++l)h[l-0]=arguments[l];var u=this;a(f);this.addEventListener("readystatechange",function(){4===u.readyState&&b(f)});return c.apply(this,h)}}
function m(a,b){var c=window.fetch;window.fetch=function(f){for(var k=[],h=0;h<arguments.length;++h)k[h-0]=arguments[h];return new Promise(function(f,h){var l=e++;a(l);c.apply(null,[].concat(d.arrayFromIterable(k))).then(function(a){b(l);f(a)},function(a){console.log("catch fetch err: ",a);b(l);h(a)})})}}var n="img script iframe link audio video source".split(" ");
function p(a,b){a=d.makeIterator(a);for(var c=a.next();!c.done;c=a.next())if(c=c.value,b.includes(c.nodeName.toLowerCase())||p(c.children,b))return!0;return!1}function q(a){var b=new MutationObserver(function(b){b=d.makeIterator(b);for(var c=b.next();!c.done;c=b.next())c=c.value,"childList"==c.type&&p(c.addedNodes,n)?a(c):"attributes"==c.type&&n.includes(c.target.tagName.toLowerCase())&&a(c)});b.observe(document,{attributes:!0,childList:!0,subtree:!0,attributeFilter:["href","src"]});return b}
function r(a){for(var b=[],c=0;c<arguments.length;++c)b[c-0]=arguments[c];console.log.apply(console,[].concat(d.arrayFromIterable(b)))}
function t(a,b){if(2<a.length)return performance.now();var c=[];b=d.makeIterator(b);for(var f=b.next();!f.done;f=b.next())f=f.value,c.push({timestamp:f.start,type:"requestStart"}),c.push({timestamp:f.end,type:"requestEnd"});b=d.makeIterator(a);for(f=b.next();!f.done;f=b.next())c.push({timestamp:f.value,type:"requestStart"});c.sort(function(a,b){return a.timestamp-b.timestamp});a=a.length;for(b=c.length-1;0<=b;b--)switch(f=c[b],f.type){case "requestStart":a--;break;case "requestEnd":a++;if(2<a)return f.timestamp;
break;default:throw Error("Internal Error: This should never happen");}return 0}
function v(a){a=void 0===a?{}:a;this._useMutationObserver=!!a.useMutationObserver;this._minValue=a.minValue||null;var b=a.ttiPropName||"__tti";a=window[b]&&window[b].e;b=window[b]&&window[b].o;a?(r("Consuming the long task entries already recorded."),this._longTasks=a.map(function(a){return{start:a.startTime,end:a.startTime+a.duration}})):this._longTasks=[];b&&b.disconnect();this._networkRequests=[];this._incompleteJSInitiatedRequestStartTimes=new Map;this._timerId=null;this._timerActivationTime=
-Infinity;this._scheduleTimerTasks=!1;this._mutationObserver=this._performanceObserver=this._firstConsistentlyInteractiveResolver=null;this._registerListeners()}v.prototype.getFirstConsistentlyInteractive=function(){var a=this;return new Promise(function(b){a._firstConsistentlyInteractiveResolver=b;"complete"==document.readyState?a.startSchedulingTimerTasks():window.addEventListener("load",function(){a.startSchedulingTimerTasks()})})};
v.prototype.startSchedulingTimerTasks=function(){r("Enabling FirstConsistentlyInteractiveDetector");this._scheduleTimerTasks=!0;var a=0<this._longTasks.length?this._longTasks[this._longTasks.length-1].end:0,b=t(this._incompleteRequestStarts,this._networkRequests);this.rescheduleTimer(Math.max(b+5E3,a))};v.prototype.setMinValue=function(a){this._minValue=a};
v.prototype.rescheduleTimer=function(a){var b=this;this._scheduleTimerTasks?(r("Attempting to reschedule FirstConsistentlyInteractive check to "+a),r("Previous timer activation time: "+this._timerActivationTime),this._timerActivationTime>a?r("Current activation time is greater than attempted reschedule time. No need to postpone."):(clearTimeout(this._timerId),this._timerId=setTimeout(function(){b._checkTTI()},a-performance.now()),this._timerActivationTime=a,r("Rescheduled firstConsistentlyInteractive check at "+
a))):r("startSchedulingTimerTasks must be called before calling rescheduleTimer")};v.prototype.disable=function(){r("Disabling FirstConsistentlyInteractiveDetector");clearTimeout(this._timerId);this._scheduleTimerTasks=!1;this._unregisterListeners()};
v.prototype._registerPerformanceObserver=function(){var a=this;this._performanceObserver=new PerformanceObserver(function(b){b=b.getEntries();b=d.makeIterator(b);for(var c=b.next();!c.done;c=b.next())c=c.value,"resource"===c.entryType&&a._networkRequestFinishedCallback(c),"longtask"===c.entryType&&a._longTaskFinishedCallback(c)});this._performanceObserver.observe({entryTypes:["longtask","resource"]})};
v.prototype._registerListeners=function(){g(this._beforeJSInitiatedRequestCallback.bind(this),this._afterJSInitiatedRequestCallback.bind(this));m(this._beforeJSInitiatedRequestCallback.bind(this),this._afterJSInitiatedRequestCallback.bind(this));this._registerPerformanceObserver();this._useMutationObserver&&(this._mutationObserver=q(this._mutationObserverCallback.bind(this)))};
v.prototype._unregisterListeners=function(){this._performanceObserver&&this._performanceObserver.disconnect();this._mutationObserver&&this._mutationObserver.disconnect()};v.prototype._beforeJSInitiatedRequestCallback=function(a){r("Starting JS initiated request. Request ID: "+a);this._incompleteJSInitiatedRequestStartTimes.set(a,performance.now());r("Active XHRs: "+this._incompleteJSInitiatedRequestStartTimes.size)};
v.prototype._afterJSInitiatedRequestCallback=function(a){r("Completed JS initiated request with request ID: "+a);this._incompleteJSInitiatedRequestStartTimes.delete(a);r("Active XHRs: "+this._incompleteJSInitiatedRequestStartTimes.size)};v.prototype._networkRequestFinishedCallback=function(a){r("Network request finished",a);this._networkRequests.push({start:a.fetchStart,end:a.responseEnd});this.rescheduleTimer(t(this._incompleteRequestStarts,this._networkRequests)+5E3)};
v.prototype._longTaskFinishedCallback=function(a){r("Long task finished",a);var b=a.startTime+a.duration;this._longTasks.push({start:a.startTime,end:b});this.rescheduleTimer(b+5E3)};v.prototype._mutationObserverCallback=function(a){r("Potentially network resource fetching mutation detected",a);r("Pushing back FirstConsistentlyInteractive check by 5 seconds.");this.rescheduleTimer(performance.now()+5E3)};
v.prototype._getMinValue=function(){if(this._minValue)return this._minValue;if(performance.timing.domContentLoadedEventEnd){var a=performance.timing;return a.domContentLoadedEventEnd-a.navigationStart}return null};
v.prototype._checkTTI=function(){r("Checking if First Consistently Interactive was reached...");var a=performance.timing.navigationStart,b=t(this._incompleteRequestStarts,this._networkRequests),c=(window.chrome&&window.chrome.loadTimes?1E3*window.chrome.loadTimes().firstPaintTime-a:0)||performance.timing.domContentLoadedEventEnd-a,f=this._getMinValue(),k=performance.now();null===f&&(r("No usable minimum value yet. Postponing check."),this.rescheduleTimer(Math.max(b+5E3,k+1E3)));r("Parameter values:");
r("NavigationStart",a);r("lastKnownNetwork2Busy",b);r("Search Start",c);r("Min Value",f);r("Last busy",b);r("Current time",k);r("Long tasks",this._longTasks);r("Incomplete JS Request Start Times",this._incompleteRequestStarts);r("Network requests",this._networkRequests);a=this._longTasks;5E3>k-b?f=null:(b=0===a.length?c:a[a.length-1].end,f=5E3>k-b?null:Math.max(b,f));f&&(this._firstConsistentlyInteractiveResolver(f),this.disable());r("Could not detect First Consistently Interactive. Retrying in 1 second.");
this.rescheduleTimer(performance.now()+1E3)};d.global.Object.defineProperties(v.prototype,{_incompleteRequestStarts:{configurable:!0,enumerable:!0,get:function(){return[].concat(d.arrayFromIterable(this._incompleteJSInitiatedRequestStartTimes.values()))}}});var w={getFirstConsistentlyInteractive:function(a){a=void 0===a?{}:a;return"PerformanceLongTaskTiming"in window?(new v(a)).getFirstConsistentlyInteractive():Promise.resolve(null)}};
"undefined"!=typeof module&&module.exports?module.exports=w:"function"===typeof define&&define.amd?define("ttiPolyfill",[],function(){return w}):window.ttiPolyfill=w;})();
//# sourceMappingURL=tti-polyfill-debug.js.map